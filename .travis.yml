language: cpp
compiler:
- clang

dist: focal
os:
- linux

addons:
  sonarcloud:
    organization: "iainchesworth"
    token:
      secure: "OZ+JPlwWew1cZHdgijtH7GmNVhtt3f/J5SERwmK79E7uHyfRxWkYm+WUBdQQs8AtNUD5Hi5Y3wxP7Jpi6lF7++iW0BPq7uxa2gvSGEdrkCCQuY4SMTD2oziyb4nmVEBPlTdY5Hc5lrrKbnZhYKywIwZR3gt1zTYGwAAMtXMIdQU5np5iWmWE3z5iZgWONLveWQkWUOAmtSZq4LqWDO+G/woBSgNVMcPJzklMCLqQDYFLlNWKx+yqyGDKVUAe2stxmjMF+QgZTGggVMZ9TRAvGzLFqOzTjeV6F4sYzW9PYQdsCvsRurJhXxVEPrGY52OOPModHZKDVbDS+tOY6jQWEOUrOYfnQIOIvYCreG5MR4eqcjfBITF6n6gNMYBu0pwu7+Sj/Rq56JpMMPD0KnIZ+Kd/zrKLECnk4aCp57Jv/t9xUlI3uaHXM8CC9EseVUxBpXxhjzZLV3kyCeBRqiKnEIps0JzL63Ocdq3XNkeEwa6PvsktpVdF4r0JZnJTCk8+bImqwDuM11Fb/3JVMHJdodjV1C2dXh3t//b2gO8Y+WgwPShKcxav0yKVV4+uiXkTGntgGEHZHOYoSLx+7AIzvI1sTczJ2mKzNq5lLtg+a3dq/InKU6GinJI7c8ElWGM4EodxJw+WHz6QLbNCwJEgn8ryoNXqJN0ddtBu9XhkIzM="

before_install:
  # Prepare the build system
  - sudo apt-get update
  - sudo apt-get -qq -y --no-install-recommends install libicu66 libssl1.1
  - sudo env "PATH=$PATH" bash ./deps/paho.mqtt.sh
  - sudo apt -qq -y --no-install-recommends install ./deps/boost/boost-build_1.76.0_amd64.deb
  - git submodule update --init --recursive --jobs 8

script:
  - cmake -Bbuild -H.
  # Wraps the compilation with the Build Wrapper to generate configuration (used
  # later by the SonarQube Scanner) into the "bw-output" folder
  - build-wrapper-linux-x86-64 --out-dir bw-output cmake --build build/

after_success:
  - NUMBER_OF_PROCESSORS=$(nproc --all)
  # And finally run the SonarQube analysis - read the "sonar-project.properties"
  # file to see the specific configuration
  - sonar-scanner -Dsonar.cfamily.build-wrapper-output=bw-output -Dsonar.cfamily.cache.enabled=true -Dsonar.cfamily.cache.path=${TRAVIS_HOME}/.cfamily -Dsonar.cfamily.threads=${NUMBER_OF_PROCESSORS}

cache:
  directories:
    - $HOME/.sonar/cache
    # This contains the CFamily cache. According to https://docs.travis-ci.com/user/caching/#pull-request-builds-and-caches,
    # for a PR, it will use the cache of the target branch if the branch of the PR does not already have its cache.
    - $HOME/.cfamily
